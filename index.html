<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5S Inventory â€“ Count</title>

  <!-- PWA setup -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#2a7a2e" />

  <style>
    /* Reset and layout */
    * { box-sizing: border-box; }
    body { margin: 0; background: #f5f5f5; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: #0f172a; }
    header { background: #2a7a2e; color: #fff; padding: 14px 16px; position: sticky; top: 0; z-index: 10; }
    header h1 { margin: 0; font-size: 20px; font-weight: 700; }
    .progress-wrap { height: 6px; background: rgba(255,255,255,0.25); border-radius: 99px; margin-top: 10px; overflow: hidden; }
    .progress { height: 100%; width: 0%; background: #fff; transition: width .25s ease; }

    main { padding: 16px; max-width: 780px; margin: 0 auto; }
    .card { background: #fff; border-radius: 14px; box-shadow: 0 1px 2px rgba(16,24,40,.06), 0 1px 3px rgba(16,24,40,.1); padding: 16px; }

    .image { width: 100%; aspect-ratio: 16/9; display: grid; place-items: center; background: #e6f0ff; color: #1557b0; border-radius: 12px; overflow: hidden; }
    .image img { width: 100%; height: 100%; object-fit: cover; }

    dl { display: grid; grid-template-columns: auto 1fr; gap: 6px 12px; margin: 16px 0; }
    dt { color: #111827; font-weight: 700; }
    dd { margin: 0; color: #374151; }

    .qty { margin-top: 10px; }
    input[type="number"] {
      width: 100%; padding: 14px 16px; font-size: 18px; border: 1px solid #d1d5db; border-radius: 12px; outline: none;
    }
    input[type="number"]:focus { border-color: #2a7a2e; box-shadow: 0 0 0 3px rgba(42,122,46,.15); }

    .btn {
      width: 100%; margin-top: 12px; padding: 14px 16px; font-size: 18px; font-weight: 700;
      background: #2a7a2e; color: #fff; border: 0; border-radius: 12px; cursor: pointer;
    }
    .btn:disabled { opacity: .6; cursor: not-allowed; }

    .meta { text-align: center; color: #6b7280; margin-top: 16px; }
    .error { background: #fff7ed; color: #b45309; border: 1px solid #fed7aa; padding: 12px; border-radius: 10px; }

    .topbar { display: flex; align-items: center; gap: 8px; }
    .spacer { flex: 1; }
    .pill { background: rgba(255,255,255,.2); padding: 2px 8px; border-radius: 999px; font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <h1>5S Inventory</h1>
      <div class="spacer"></div>
      <span class="pill" id="progressText">Item 0 of 0</span>
    </div>
    <div class="progress-wrap"><div class="progress" id="progressBar"></div></div>
  </header>

  <main>
    <div class="card">
      <div class="image" id="imageWrap" aria-label="Item image">
        <img id="image" alt="Item image" hidden />
        <!-- Placeholder graphic for missing images -->
        <svg id="placeholder" width="140" height="90" viewBox="0 0 140 90" aria-hidden="true">
          <rect width="140" height="90" fill="#e6f0ff" />
          <text x="50%" y="55%" text-anchor="middle" font-size="40" fill="#1557b0" font-family="Arial, sans-serif">5S</text>
        </svg>
      </div>

      <dl id="details">
        <!-- Product details will be injected here -->
      </dl>

      <div class="qty">
        <label for="qtyInput" class="sr-only">Quantity</label>
        <input id="qtyInput" type="number" inputmode="numeric" min="0" step="1" placeholder="Enter quantity" />
      </div>

      <button id="saveBtn" class="btn">Save & Next</button>
      <p class="meta" id="metaText"></p>
      <div id="errorBox" class="error" hidden></div>
    </div>
  </main>

  <script>
    // Data version used for cache-busting. Bump when data.json changes.
    const DATA_VERSION = 'v5';

    // Local storage keys
    const LS_QTY = 'inv.quantities';
    const LS_IDX = 'inv.index';

    // State
    let items = [];
    let currentIndex = 0;
    let quantities = loadQuantities();

    // Elements
    const detailsEl = document.getElementById('details');
    const qtyInput = document.getElementById('qtyInput');
    const saveBtn = document.getElementById('saveBtn');
    const metaText = document.getElementById('metaText');
    const progressText = document.getElementById('progressText');
    const progressBar = document.getElementById('progressBar');
    const errBox = document.getElementById('errorBox');
    const img = document.getElementById('image');
    const placeholder = document.getElementById('placeholder');

    // Load quantities from local storage
    function loadQuantities() {
      try { return JSON.parse(localStorage.getItem(LS_QTY) || '{}'); } catch { return {}; }
    }
    // Save quantities to local storage
    function saveQuantities() {
      localStorage.setItem(LS_QTY, JSON.stringify(quantities));
    }

    // Format numbers according to English locale
    function fmtNumber(n) {
      return Intl.NumberFormat('en-CA').format(n);
    }

    // Display the current item in the UI
    function showItem(i) {
      if (!items.length) return;
      const it = items[i];

      // Build details list in English
      detailsEl.innerHTML = `
        <dt>Name:</dt><dd>${it.name || '-'}</dd>
        <dt>Category:</dt><dd>${it.category || '-'}</dd>
        <dt>Unit:</dt><dd>${it.unit || '-'}</dd>
        <dt>Min / Target:</dt><dd>${fmtNumber(it.par || 0)} / ${fmtNumber(it.reorderTo || 0)}</dd>
        <dt>Supplier:</dt><dd>${it.supplier || '-'}</dd>
        <dt>Notes:</dt><dd>${it.notes || '-'}</dd>
      `;

      // Handle image or placeholder
      if (it.image) {
        img.src = it.image;
        img.hidden = false;
        placeholder.hidden = true;
      } else {
        img.hidden = true;
        placeholder.hidden = false;
      }

      // Pre-fill quantity input with stored value
      const saved = quantities[it.id] ?? '';
      qtyInput.value = saved === '' ? '' : String(saved);

      // Update progress display
      progressText.textContent = `Item ${i + 1} of ${items.length}`;
      metaText.textContent = `ID: ${it.id}`;
      progressBar.style.width = `${((i + 1) / items.length) * 100}%`;
    }

    // Advance to the next item (wrap-around)
    function next() {
      currentIndex = (currentIndex + 1) % items.length;
      localStorage.setItem(LS_IDX, String(currentIndex));
      showItem(currentIndex);
    }

    // Handle save & next button click
    saveBtn.addEventListener('click', () => {
      errBox.hidden = true;
      if (!items.length) return;
      const it = items[currentIndex];

      const v = qtyInput.value.trim();
      if (v === '' || isNaN(v) || Number(v) < 0) {
        errBox.hidden = false;
        errBox.textContent = 'Please enter a non-negative number.';
        qtyInput.focus();
        return;
      }
      quantities[it.id] = Number(v);
      saveQuantities();
      next();
    });

    // Fetch data.json (network-first) and populate items
    fetch(new URL(`./data.json?ver=${DATA_VERSION}`, location.href), { cache: 'no-store' })
      .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
      .then(data => {
        items = Array.isArray(data) ? data : [];
        if (!items.length) throw new Error('No items in data.json');
        const savedIndex = Number(localStorage.getItem(LS_IDX) || 0);
        currentIndex = isNaN(savedIndex) ? 0 : Math.max(0, Math.min(savedIndex, items.length - 1));
        showItem(currentIndex);
      })
      .catch(err => {
        saveBtn.disabled = true;
        errBox.hidden = false;
        errBox.textContent = 'Failed to load data: ' + err.message;
      });

    // Register service worker with local scope to avoid hijacking other pages
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(() => {});
      });
    }
  </script>
</body>
</html>
