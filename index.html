<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>۵S Inventory – ثبت موجودی</title>
  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#2a7a2e" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; background: #f5f5f5; direction: rtl;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: #222; text-align: center;
    }
    header { background:#2a7a2e; color:#fff; padding:14px 16px; font-weight:600; }
    #progress { max-width: 520px; width: 90%; margin: 10px auto 0; height: 6px; background:#e0e0e0; border-radius: 999px; overflow: hidden; }
    #progressBar { width: 0; height: 100%; background:#2a7a2e; }

    #card {
      max-width: 520px; width: 90%; margin: 14px auto; background:#fff;
      border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,.08); overflow: hidden;
    }
    #card img { width: 100%; height: 220px; object-fit: cover; background:#ddd; }
    #details { text-align: right; padding: 10px 14px; line-height: 1.6; }
    #details strong { font-weight: 700; }
    #qtyInput { width: 100%; padding: .7rem; margin: .6rem 0; border: 1px solid #d0d0d0; border-radius: 8px; text-align: center; font-size: 1.05rem; }
    #saveBtn { width: 100%; background:#2a7a2e; color:#fff; border:none; border-radius: 8px; padding: .9rem; font-size:1.05rem; cursor:pointer; }
    #saveBtn:disabled { opacity:.6; cursor:not-allowed; }
    footer { color:#666; font-size:.88rem; margin: 10px 0 24px; }
    #toast {
      position: fixed; left: 50%; transform: translateX(-50%); bottom: 16px;
      background:#2a7a2e; color:#fff; padding:10px 14px; border-radius:999px; display:none;
    }
  </style>
</head>
<body>
  <header>۵S Inventory</header>
  <div id="progress"><div id="progressBar"></div></div>

  <div id="card">
    <img id="productImage" src="./icon-512.png" alt="تصویر محصول" />
    <div id="details"></div>
    <div style="padding: 0 14px 14px;">
      <input id="qtyInput" inputmode="numeric" placeholder="موجودی را وارد کنید" />
      <button id="saveBtn">ذخیره و بعدی</button>
    </div>
  </div>

  <footer id="footer"></footer>
  <div id="toast">ثبت شد</div>

  <script>
    // Simple toast
    function toast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg || 'ثبت شد';
      t.style.display = 'block';
      clearTimeout(t.__timer); t.__timer = setTimeout(()=>t.style.display='none', 1200);
    }

    // Local storage helpers
    function loadQuantities() {
      try { return JSON.parse(localStorage.getItem('inventoryQuantities')) || {}; }
      catch { return {}; }
    }
    function saveQuantities(q) {
      localStorage.setItem('inventoryQuantities', JSON.stringify(q));
    }

    // State
    let items = [];
    let currentIndex = 0;
    let quantities = loadQuantities();

    function updateProgress() {
      const p = (currentIndex / items.length) * 100;
      document.getElementById('progressBar').style.width = p + '%';
      document.getElementById('footer').textContent =
        items.length ? `آیتم ${currentIndex+1} از ${items.length}` : '';
    }

    function showItem(i) {
      const elDetails = document.getElementById('details');
      const img = document.getElementById('productImage');
      if (!items.length) {
        elDetails.innerHTML = '<p style="margin:1rem">آیتمی نیافت نشد.</p>';
        img.src = './icon-512.png';
        document.getElementById('saveBtn').disabled = true;
        return;
      }
      const item = items[i];
      img.src = item.image ? item.image : './icon-512.png';
      img.onerror = () => { img.src = './icon-512.png'; };

      elDetails.innerHTML =
        `<strong>نام:</strong> ${item.name || '-'}<br>` +
        `<strong>دسته:</strong> ${item.category || '-'}<br>` +
        `<strong>واحد:</strong> ${item.unit || '-'}<br>` +
        `<strong>کمینه/ بهینه:</strong> ${(item.par ?? 0)} / ${(item.reorderTo ?? 0)}<br>` +
        (item.brand ? `<strong>برند:</strong> ${item.brand}<br>` : '') +
        (item.supplier ? `<strong>تامین‌کننده:</strong> ${item.supplier}<br>` : '') +
        (item.notes ? `<strong>یادداشت:</strong> ${item.notes}<br>` : '');

      const qInput = document.getElementById('qtyInput');
      qInput.value = (quantities[item.id] ?? '');
      updateProgress();
    }

    // Save & next
    document.getElementById('saveBtn').addEventListener('click', () => {
      if (!items.length) return;
      const item = items[currentIndex];
      const v = Number(document.getElementById('qtyInput').value || 0);
      quantities[item.id] = isFinite(v) ? v : 0;
      saveQuantities(quantities);
      toast('ثبت شد');

      currentIndex = (currentIndex + 1);
      if (currentIndex >= items.length) currentIndex = 0;
      showItem(currentIndex);
    });

    // Load data
    fetch(new URL('./data.json', location.href))
      .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
      .then(data => {
        items = Array.isArray(data) ? data : [];
        currentIndex = 0;
        showItem(currentIndex);
      })
      .catch(err => {
        document.getElementById('details').innerHTML =
          `<p style="padding:1rem">خطا در بارگذاری داده‌ها: ${err.message}</p>`;
        document.getElementById('saveBtn').disabled = true;
      });

    // Register SW with *limited scope* to avoid hijacking other pages
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(()=>{});
    }
  </script>
</body>
</html>
